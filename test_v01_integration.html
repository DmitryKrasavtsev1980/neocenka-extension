<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã v0.1</title>
    <link rel="stylesheet" href="libs/tailwind/tailwind.min.css">
    <style>
        .test-result {
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .test-success {
            background: #f0f9f4;
            border-color: #22c55e;
            color: #15803d;
        }
        .test-error {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }
        .test-warning {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #d97706;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-6">üß™ –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã v0.1</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h2>
            <div id="test-results">
                <div class="test-result test-warning">
                    <strong>–û–∂–∏–¥–∞–Ω–∏–µ...</strong> –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏...
                </div>
            </div>
            
            <div class="mt-6">
                <button id="run-tests" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                    –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
                </button>
                <button id="clear-results" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded ml-2">
                    –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                </button>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∞–∑–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ -->
    <script src="libs/jquery/jquery-3.7.1.min.js"></script>
    <script src="data/database.js"></script>
    <script src="data/models.js"></script>
    <script src="utils/debug-logger.js"></script>
    
    <!-- Core –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ -->
    <script src="pages/core/DataState.js"></script>
    <script src="pages/core/EventBus.js"></script>
    <script src="pages/core/ProgressManager.js"></script>
    
    <!-- –°–µ—Ä–≤–∏—Å—ã v0.1 -->
    <script src="services/core/ValidationService.js"></script>
    <script src="services/core/ConfigService.js"></script>
    <script src="services/core/ErrorHandlingService.js"></script>
    <script src="services/core/GlobalErrorReporter.js"></script>
    <script src="services/core/DIContainer.js"></script>
    <script src="services/data/ReferenceDataService.js"></script>
    <script src="services/data/SegmentService.js"></script>
    
    <!-- UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã v0.1 -->
    <script src="components/ui/SegmentModal.js"></script>
    <script src="components/ui/SegmentTable.js"></script>
    <script src="components/ui/SegmentChart.js"></script>
    
    <!-- –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã v0.1 -->
    <script src="controllers/SegmentController.js"></script>
    <script src="controllers/MapController.js"></script>
    <script src="controllers/ApplicationController.js"></script>

    <script>
        class V01IntegrationTester {
            constructor() {
                this.results = [];
                this.applicationController = null;
                this.diContainer = null;
            }
            
            /**
             * –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ç–µ—Å—Ç–∞
             */
            addResult(name, success, message, details = null) {
                this.results.push({
                    name,
                    success,
                    message,
                    details,
                    timestamp: new Date()
                });
                this.updateDisplay();
            }
            
            /**
             * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
             */
            updateDisplay() {
                const container = document.getElementById('test-results');
                container.innerHTML = '';
                
                this.results.forEach(result => {
                    const div = document.createElement('div');
                    div.className = `test-result ${result.success ? 'test-success' : 'test-error'}`;
                    
                    div.innerHTML = `
                        <strong>${result.success ? '‚úÖ' : '‚ùå'} ${result.name}</strong><br>
                        ${result.message}
                        ${result.details ? `<br><small>${result.details}</small>` : ''}
                    `;
                    
                    container.appendChild(div);
                });
            }
            
            /**
             * –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
             */
            async runAllTests() {
                this.results = [];
                this.updateDisplay();
                
                try {
                    // –¢–µ—Å—Ç 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                    await this.testDatabaseInit();
                    
                    // –¢–µ—Å—Ç 2: –°–æ–∑–¥–∞–Ω–∏–µ ApplicationController
                    await this.testApplicationController();
                    
                    // –¢–µ—Å—Ç 3: DI Container
                    await this.testDIContainer();
                    
                    // –¢–µ—Å—Ç 4: –°–µ—Ä–≤–∏—Å—ã
                    await this.testServices();
                    
                    // –¢–µ—Å—Ç 5: –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
                    await this.testControllers();
                    
                    // –¢–µ—Å—Ç 6: UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
                    await this.testUIComponents();
                    
                    this.addResult('–û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç', true, '–í—Å–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã');
                    
                } catch (error) {
                    this.addResult('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞', false, error.message);
                }
            }
            
            /**
             * –¢–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
             */
            async testDatabaseInit() {
                try {
                    if (typeof NeocenkaDB === 'undefined') {
                        throw new Error('NeocenkaDB –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                    }
                    
                    const db = new NeocenkaDB();
                    await db.init();
                    
                    this.addResult('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö', true, 'NeocenkaDB –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                } catch (error) {
                    this.addResult('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö', false, '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
                }
            }
            
            /**
             * –¢–µ—Å—Ç ApplicationController
             */
            async testApplicationController() {
                try {
                    if (typeof ApplicationController === 'undefined') {
                        throw new Error('ApplicationController –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
                    }
                    
                    this.applicationController = new ApplicationController();
                    
                    // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                    let attempts = 0;
                    while (!this.applicationController.state.initialized && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                    
                    if (!this.applicationController.state.initialized) {
                        throw new Error('ApplicationController –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è –∑–∞ 5 —Å–µ–∫—É–Ω–¥');
                    }
                    
                    this.addResult('ApplicationController', true, '–°–æ–∑–¥–∞–Ω –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');
                } catch (error) {
                    this.addResult('ApplicationController', false, '–û—à–∏–±–∫–∞: ' + error.message);
                }
            }
            
            /**
             * –¢–µ—Å—Ç DI Container
             */
            async testDIContainer() {
                try {
                    if (!this.applicationController) {
                        throw new Error('ApplicationController –Ω–µ –≥–æ—Ç–æ–≤');
                    }
                    
                    this.diContainer = this.applicationController.container;
                    
                    if (!this.diContainer) {
                        throw new Error('DI Container –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ ApplicationController');
                    }
                    
                    this.addResult('DI Container', true, '–ü–æ–ª—É—á–µ–Ω –∏–∑ ApplicationController');
                } catch (error) {
                    this.addResult('DI Container', false, '–û—à–∏–±–∫–∞: ' + error.message);
                }
            }
            
            /**
             * –¢–µ—Å—Ç —Å–µ—Ä–≤–∏—Å–æ–≤
             */
            async testServices() {
                if (!this.diContainer) {
                    this.addResult('–°–µ—Ä–≤–∏—Å—ã', false, 'DI Container –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    return;
                }
                
                const services = [
                    'ValidationService',
                    'ConfigService', 
                    'ErrorHandlingService',
                    'Database'
                ];
                
                for (const serviceName of services) {
                    try {
                        const service = this.diContainer.get(serviceName);
                        if (service) {
                            this.addResult(`–°–µ—Ä–≤–∏—Å: ${serviceName}`, true, '–ü–æ–ª—É—á–µ–Ω —á–µ—Ä–µ–∑ DI Container');
                        } else {
                            this.addResult(`–°–µ—Ä–≤–∏—Å: ${serviceName}`, false, '–í–µ—Ä–Ω—É–ª null/undefined');
                        }
                    } catch (error) {
                        this.addResult(`–°–µ—Ä–≤–∏—Å: ${serviceName}`, false, '–û—à–∏–±–∫–∞: ' + error.message);
                    }
                }
            }
            
            /**
             * –¢–µ—Å—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤
             */
            async testControllers() {
                if (!this.applicationController) {
                    this.addResult('–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã', false, 'ApplicationController –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    return;
                }
                
                const controllers = ['SegmentController', 'MapController'];
                
                for (const controllerName of controllers) {
                    try {
                        const controller = this.applicationController.controllers.get(controllerName);
                        if (controller) {
                            this.addResult(`–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä: ${controllerName}`, true, '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ ApplicationController');
                        } else {
                            this.addResult(`–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä: ${controllerName}`, false, '–ù–µ –Ω–∞–π–¥–µ–Ω –≤ ApplicationController');
                        }
                    } catch (error) {
                        this.addResult(`–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä: ${controllerName}`, false, '–û—à–∏–±–∫–∞: ' + error.message);
                    }
                }
            }
            
            /**
             * –¢–µ—Å—Ç UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
             */
            async testUIComponents() {
                const components = [
                    'SegmentModal',
                    'SegmentTable', 
                    'SegmentChart'
                ];
                
                for (const componentName of components) {
                    try {
                        if (typeof window[componentName] !== 'undefined') {
                            this.addResult(`UI: ${componentName}`, true, '–ö–ª–∞—Å—Å –∑–∞–≥—Ä—É–∂–µ–Ω');
                        } else {
                            this.addResult(`UI: ${componentName}`, false, '–ö–ª–∞—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ window');
                        }
                    } catch (error) {
                        this.addResult(`UI: ${componentName}`, false, '–û—à–∏–±–∫–∞: ' + error.message);
                    }
                }
            }
            
            /**
             * –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
             */
            clearResults() {
                this.results = [];
                this.updateDisplay();
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–µ—Ä–∞
        const tester = new V01IntegrationTester();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('run-tests').addEventListener('click', () => {
            tester.runAllTests();
        });
        
        document.getElementById('clear-results').addEventListener('click', () => {
            tester.clearResults();
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                tester.runAllTests();
            }, 1000);
        });
    </script>
</body>
</html>