# Описание задачи
Теперь сделаем функционал панели сегментов. Составь план реализации и приступай, ничего не придумывай, если будут вопросы, то спрашивай.

В панели сегментов должен быть следующий функционал:

Таблица сегментов, в которой должны показываться сегменты. с кнопкой создать
название колонок таблицы: иконка подходящая под столбец действия по раскрытию дочерних элементов строки, Наименование, количество домов, количество подсегментов.
управление: редактировать, удалить.
При нажатии на первую колонку нужно открывать дочернюю таблицу с подсегментами
Для реализации функционала таблицы изучи реализацию таблицы дублей.

Создание/редактирование сегмента во всплывающем окне:

1. фильтр с функцией сохранения:

сегмент - это несколько домов(адресов) входящих в полигон на карте(полигон области), которые объединены общими характеристиками.

Набор характеристик сегмента состоит из параметров адреса:
1.1. Тип: выпадающий список со значениями из адресов, которые попадают в полигон области.
1.2. Класс дома: выпадающий список со значениями из адресов, которые попадают в полигон области.
1.3. Серия: выпадающий список со значениями из адресов, которые попадают в полигон области.
1.4. Материал стен: выпадающий список со значениями из адресов, которые попадают в полигон области.
1.5. Материал перекрытий: выпадающий список со значениями из адресов, которые попадают в полигон области.
1.6. Газоснабжение: выпадающий список со значениями из адресов, которые попадают в полигон области.
1.7. Этажность: поля ввода от - до, по умолчанию должны применяться этажности от 1 до 100
1.8. Год постройки: поля ввода от - до, по умолчанию должны применяться значения от 1800 до текущего года
1.9. Список адресов: поле для выбора адресов с отметкой нужных адресов, которые нужны.

Название сегмента нужно формировать автоматически из сокращений параметров. Пример названия: Москва, ЮЗАО-ЗАО, Гагаринский-Обручевский-Ломоносовский-Проспект Вернадского-Раменки, Серии [СМ-06], Класс [Стандарт, Комфорт], Года [1955, 1956, 1957, 1958, 1959, 1960, 1961], Этажность [7, 8, 9, 10]. 
То есть: Название области, Серии домов, Классы домов, Года постройки, Этажности.



2. карта с отображением адресов. карта аналогичная карте области с таким же набором отображения адресов на карте (ничего не придумывай возьми реализацию отображения карты и адресов из карты области). 
Маркеты адресов, которые попадают под фильтр должны отображаться с нулевой прозрачностью, а маркеры адересов, которые не паподают под фильтр должны быть с прозрачностью 70%.

3. ниже карты нужно расположить график распределения площадей(общей площади) по типам недвижимости. пример графика на картинке ./example/02.png
Если не знаешь как лучше сделать график, то спроси и я пришлю пример кода графика.

4. ниже графика нужно расположить фильтр подсегментов с выпадающим списком подсегментов и полями формы фильтра подсегментов, которые нужно редактировать. При выборе подсегмента в выпадающем списке нужно заполнять поля на форме фильтра подсегментов и сохранять. Если в выпадающем списке не выбран подсегмент, то при на нажатии кнопки сохранить нужно создавать новый подсегмент. Так же должна быть кнопка удаления подсегмента.
 
Набор характеристик подсегмента состоит из параметров адреса:
1.1. Тип недвижимости: 
1.2. Этаж: поля ввода от - до, по умолчанию должны применяться этаж от 1 до 100
1.3. Цена: поля ввода от - до, по умолчанию должны применяться значения от 1 до 10000000000

Название подсегмента нужно формировать автоматически из сокращений параметров.
Пример названия: ТН[1к,2к], Этажи [5 - 10], Цена [4 000 000 - 10 000 000]. 
То есть: Типы недвижимости, Этажи, Цена.

5. Таблица с подсегментами, с колонками: название, этажи, цена.
при выборе одного из подсегментов в таблице нужно менять цвет выбранного сегмента на графике распределения площадей: точки с площадями попадающими под фильтр выбранного подсегмента нужно окрасить в фиолетовый цвет.



# Состояние задачи: Реализация функционала панели сегментов

## Исходная задача от пользователя

Реализовать функционал панели сегментов со следующими возможностями:

1. **Таблица сегментов** с раскрывающимися строками для подсегментов
2. **Модальное окно создания/редактирования сегмента** с фильтрами:
   - Тип недвижимости (дом, дом с участком, участок, коммерческая, здание)
   - Класс дома (справочник)
   - Серия дома (справочник)
   - Материал стен (справочник)
   - Материал перекрытий (справочник)
   - Газоснабжение (да/нет/не указано)
   - Этажность (от 1 до 100)
   - Годы постройки (от 1800 до текущего)
   - Выбор конкретных адресов (опционально)
3. **Карта с адресами** и прозрачностью в зависимости от фильтра
4. **График распределения площадей** по типам недвижимости (scatter plot)
5. **Фильтр подсегментов** с формой и сохранением состояния
6. **Таблица подсегментов** с выделением на графике
7. **Автоматическое формирование названий** сегментов и подсегментов

## Что уже сделано

### 1. HTML структура (area.html, строки 1827-1999)
- ✅ Создано модальное окно `#segmentModal`
- ✅ Форма с всеми необходимыми фильтрами
- ✅ Место для карты `#segmentMap`
- ✅ Responsive дизайн с двумя колонками
- ✅ Таблица сегментов `#segmentsTable` уже существовала в HTML

### 2. JavaScript функциональность (segments-functionality.js)
- ✅ Полная инициализация таблицы сегментов с DataTables
- ✅ Обработка раскрывающихся строк для подсегментов
- ✅ Модальное окно с загрузкой справочных данных
- ✅ Карта Leaflet с отображением адресов области
- ✅ Сохранение/загрузка сегментов из IndexedDB
- ✅ Фильтрация адресов по критериям сегмента
- ✅ Автоматическая генерация названий сегментов
- ✅ Управление подсегментами (создание, редактирование, удаление)

### 3. Ключевые методы в segments-functionality.js
- `initializeSegments()` - основная инициализация
- `initializeSegmentsTable()` - настройка DataTables
- `openSegmentModal()` - открытие модального окна
- `saveSegment()` - сохранение сегмента
- `loadSegments()` - загрузка и отображение
- `initializeSegmentMap()` - карта в модальном окне
- `addressMatchesSegmentFilters()` - фильтрация адресов
- `generateSegmentName()` - автоматические названия

## Что нужно сделать дальше

### Немедленные шаги (высокий приоритет):
1. **Интеграция JavaScript кода**:
   - Добавить код из `segments-functionality.js` в класс `AreaPage` перед строкой 13074
   - Добавить вызов `this.initializeSegments()` в метод инициализации страницы
   - Добавить свойство `this.segmentsTable = null;` в конструктор

2. **Тестирование базовой функциональности**:
   - Проверить открытие модального окна
   - Проверить сохранение сегмента
   - Проверить отображение в таблице

### Следующие функции (средний приоритет):
3. **График распределения площадей**:
   - Использовать ApexCharts для scatter plot
   - Отображать типы недвижимости по осям
   - Интеграция с фильтрами сегмента

4. **Фильтр подсегментов**:
   - Создать форму фильтра подсегментов
   - Добавить сохранение состояния в localStorage
   - Интеграция с таблицей подсегментов

5. **Таблица подсегментов**:
   - Расширить раскрывающиеся строки
   - Добавить выделение на графике
   - Функции создания/редактирования

### Улучшения (низкий приоритет):
6. **SlimSelect интеграция**:
   - Заменить обычные select на SlimSelect для множественного выбора
   - Улучшить UX выбора фильтров

7. **Дополнительные функции**:
   - Экспорт/импорт сегментов
   - Копирование сегментов
   - Статистика по сегментам

## Файлы для работы

- **HTML**: `/mnt/c/Projects/neocenka-extension/pages/area.html` (строки 1827-1999)
- **JavaScript**: `/mnt/c/Projects/neocenka-extension/pages/area.js` (добавить перед строкой 13074)
- **Код для интеграции**: `/mnt/c/Projects/neocenka-extension/pages/segments-functionality.js`

## Технические детали

### База данных
- Таблица `segments`: id, map_area_id, name, filters, created_at, updated_at
- Таблица `subsegments`: id, segment_id, name, filters, created_at, updated_at
- Связь: Area -> Segments -> Subsegments

### Структура фильтров
```javascript
filters: {
    type: ['house', 'commercial'],
    house_class_id: ['id_001', 'id_002'],
    house_series_id: ['id_series_1'],
    wall_material_id: ['brick', 'panel'],
    ceiling_material_id: ['reinforced_concrete'],
    gas_supply: ['true', 'false'],
    floors_from: 1,
    floors_to: 10,
    build_year_from: 1960,
    build_year_to: 2020,
    addresses: ['addr_id_1', 'addr_id_2'] // опционально
}
```

### Пример автоматического названия
"Академический, Дома, 5-9 эт., 1960-1980 гг."

## Состояние TODO

1. ✅ Изучить реализацию таблицы дублей
2. ✅ Создать основную таблицу сегментов
3. ✅ Реализовать модальное окно сегмента
4. ⏳ Добавить JavaScript функциональность (готов к интеграции)
5. ⏳ Добавить карту с адресами (базовая реализация готова)
6. ⏳ Реализовать график распределения площадей
7. ⏳ Создать фильтр подсегментов
8. ⏳ Реализовать таблицу подсегментов
9. ⏳ Автоматическое формирование названий (базовая логика готова)

## Для продолжения работы

1. Прочитать этот файл
2. Проверить todo список командой TodoRead
3. Интегрировать код из segments-functionality.js в area.js
4. Продолжить с пункта 4 в todo (график распределения)