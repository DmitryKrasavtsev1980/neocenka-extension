# HTMLExportManager

Менеджер для экспорта отчётов области в автономные HTML-файлы с полной функциональностью.

## Обзор

`HTMLExportManager` создаёт самодостаточные HTML-отчёты, которые содержат все данные, стили и JavaScript-код, необходимые для работы без подключения к интернету. Отчёт включает интерактивную карту, графики, таблицы и систему сравнительного анализа.

## Основные возможности

### ✅ Архитектура блоков (6 основных секций)

1. **Статистика области** - общие показатели по региону
2. **Интерактивная карта** - карта с маркерами и фильтрами отображения  
3. **Фильтры отчёта** - настройки и параметры анализа
4. **Аналитические графики** - ликвидность, цены, рыночные коридоры
5. **Сравнительный анализ** - инструмент оценки объектов недвижимости
6. **Таблица объектов** - DataTables с модальными окнами объявлений

### ✅ Пользовательский интерфейс

- **Сворачиваемые панели** - все секции можно скрыть/показать
- **Панель управления** - централизованное управление видимостью блоков
- **Адаптивный дизайн** - использует Tailwind CSS
- **Автономность** - все зависимости встроены в HTML

### ✅ Интерактивные компоненты

- **Leaflet карты** с кластеризацией маркеров
- **ApexCharts графики** с анимацией и интерактивностью  
- **DataTables** с поиском, сортировкой и пагинацией
- **Модальные окна** для детального просмотра объявлений

## Архитектура класса

### Основные методы

#### `generateHTMLReport(exportData)`
Главный метод генерации HTML-отчёта.

**Параметры:**
- `exportData` - объект с данными области, включающий:
  - `area` - информация об области
  - `real_estate_objects` - объекты недвижимости
  - `listings` - объявления
  - `addresses` - адреса
  - `charts_data` - данные для графиков

**Возвращает:** HTML-строку готового отчёта

#### `generateHTMLStructure(exportData)`
Создаёт основную HTML-структуру документа.

**Возможности:**
- DOCTYPE и мета-теги для корректного отображения
- Подключение внешних библиотек через CDN
- Встроенные стили для оформления
- Структура блоков с поддержкой сворачивания

#### `generateEmbeddedScripts(exportData)`
Генерирует встроенные JavaScript-скрипты для функциональности.

**Особенности:**
- Безопасная сериализация данных через `JSON.stringify` с фильтрацией
- Инициализация всех компонентов интерфейса
- Обработка событий панелей управления
- Интеграция с внешними библиотеками

### Генераторы блоков

#### `generateStatisticsBlock(exportData)`
Создаёт блок статистики области.

**Включает:**
- Общее количество объектов и объявлений
- Площадь области в км²
- Средние цены и диапазоны
- Распределение по типам домов

#### `generateMapBlock(exportData)`  
Генерирует интерактивную карту с фильтрами.

**Функции:**
- Отображение полигона области
- Маркеры адресов с фильтрацией
- Кнопки переключения режимов отображения
- Цветовое кодирование по году постройки

#### `generateFiltersBlock(exportData)`
Создаёт панель фильтров и настроек.

**Содержит:**
- Параметры сегмента области
- Настройки отображения данных
- Фильтры по статусу объявлений

#### `generateChartsBlock(exportData)`
Формирует блок аналитических графиков.

**Графики:**
- **Ликвидность** - динамика активности рынка
- **Цены** - тренды стоимости недвижимости  
- **Рыночные коридоры** - диапазоны цен

#### `generateComparativeAnalysisBlock(exportData)`
Создаёт инструмент сравнительного анализа.

**Возможности:**
- Выбор объектов для сравнения
- Система оценок (лучше/похож/хуже)
- Расчёт ценовых коридоров
- Интерактивный график сравнения
- Рекомендации по ценообразованию

#### `generateDuplicatesTableBlock(exportData)`
Генерирует таблицу объектов недвижимости.

**Функции:**
- DataTables с русской локализацией
- Поиск и сортировка по столбцам
- Клик по количеству объявлений открывает модальное окно
- Отображение основных характеристик объектов

### Вспомогательные методы

#### `generateReportHeader(title, date, area)`
Создаёт заголовок отчёта с мета-информацией.

#### `generateExternalLibraries()`
Подключает внешние библиотеки через CDN:
- jQuery 3.7.1
- Tailwind CSS
- Leaflet для карт
- ApexCharts для графиков
- DataTables для таблиц

#### `generateEmbeddedStyles()`
Встроенные CSS-стили для:
- Оформления панелей и модальных окон
- Стилизации кнопок и элементов управления
- Адаптивной вёрстки компонентов

## Встроенная JavaScript функциональность

### Инициализация компонентов

```javascript
// Порядок инициализации при загрузке DOM
initPanelControls();     // Управление панелями
initStatistics();        // Заполнение статистики  
initDataTables();        // Инициализация таблицы
initCharts();           // Создание графиков
initComparativeAnalysis(); // Сравнительный анализ
initMap();              // Настройка карты
initModals();           // Модальные окна
```

### Управление панелями

#### `initPanelControls()`
- Переключение видимости секций
- Сворачивание/разворачивание контента
- Анимация chevron иконок
- Сохранение состояния панелей

### Работа с данными

#### `initStatistics()`
- Подсчёт агрегированных показателей
- Форматирование чисел и валют
- Расчёт площади полигона области
- Группировка данных по категориям

#### `initDataTables()`
- Создание интерактивной таблицы объектов
- Настройка колонок и их рендеринга
- Обработка кликов для открытия модальных окон
- Стилизация элементов поиска и пагинации

### Графики и визуализация

#### `initCharts()`
Инициализирует три типа графиков:

**Ликвидность (`initLiquidityChart`)**
- Линейный график активности рынка
- Отображение трендов по времени

**Цены (`initPriceChart`)**  
- График динамики цен
- Средние показатели по периодам

**Рыночные коридоры (`initMarketCorridorChart`)**
- Диаграмма диапазонов цен
- Сравнение активных и архивных объявлений

### Сравнительный анализ

#### `initComparativeAnalysis()`
Полнофункциональный инструмент анализа с:

**Управление состоянием:**
```javascript
const analysisState = {
    isActive: false,
    currentObjects: [],
    selectedObjectId: null,
    evaluations: new Map(),
    corridors: { active: {}, archive: {}, optimal: {} }
};
```

**Функции оценки:**
- `startComparativeAnalysis()` - запуск анализа
- `evaluateObject(objectId)` - оценка объекта (лучше/похож/хуже)
- `calculatePriceCorridors()` - расчёт ценовых коридоров
- `updateRecommendedPrice()` - рекомендуемая цена

**Интерактивный график:**
- Scatter plot с точками объектов
- Цветовое кодирование по оценкам
- Tooltip с детальной информацией
- Обновление при изменении оценок

### Картографический модуль

#### `initMap()`
- Создание карты с центрированием по области
- Отображение полигона границ
- Добавление маркеров адресов
- Фильтры отображения по различным параметрам
- Цветовое кодирование маркеров

**Фильтры отображения:**
- Год постройки (`year`)
- Серия дома (`series`) 
- Этажность (`floors`)
- Количество объектов (`objects`)
- Количество объявлений (`listings`)
- Класс дома (`house_class`)
- Проблемы дома (`house_problems`)
- Коммерческие помещения (`commercial_spaces`)
- Комментарии (`comment`)

### Модальные окна

#### `openListingsModal(objectId)`
Открывает модальное окно с объявлениями по объекту:
- Динамическое создание HTML-контента
- Таблица с детальной информацией об объявлениях
- Ссылки на источники объявлений
- Статусы и цены с форматированием

#### `initModals()`
- Обработчики закрытия модальных окон
- Закрытие по клику вне области
- Закрытие по кнопке "×"

## Технические особенности

### Обработка данных

#### Безопасная сериализация JSON
```javascript
JSON.stringify(exportData, (key, value) => {
    // Убираем функции и undefined значения
    if (typeof value === 'function' || typeof value === 'undefined') {
        return null;
    }
    // Убираем DOM элементы
    if (value && typeof value === 'object' && value.nodeType) {
        return null;
    }
    return value;
}, 2)
```

#### Форматирование валют и чисел
- Использование `Intl.NumberFormat('ru-RU')` для русской локализации
- Обработка null/undefined значений
- Автоматическое сокращение больших чисел

### CSS и стилизация

#### Tailwind CSS интеграция
- Подключение через CDN для автономности
- Кастомные классы для специфических компонентов
- Адаптивность для различных экранов

#### Анимации и переходы
```css
.section-content {
    transition: max-height 0.3s ease-out;
}
.chevron {
    transition: transform 0.3s ease;
}
```

### Производительность

#### Ленивая инициализация
- Графики создаются только при наличии данных
- Карта инициализируется после DOM
- DataTables с оптимизированными настройками

#### Оптимизация памяти
- Очистка старых экземпляров перед созданием новых
- Правильное удаление event listeners
- Минимизация глобальных переменных

## Интеграция с основным приложением

### ReportsManager интеграция
```javascript
// В ReportsManager.js
if (this.htmlExportManager) {
    await this.htmlExportManager.downloadHTMLReport(exportData, filename);
}
```

### Передача данных
Экспортируемые данные должны содержать:
- `area` - объект области с полигоном и мета-данными
- `real_estate_objects` - массив объектов недвижимости
- `listings` - массив объявлений с привязкой к объектам
- `addresses` - массив адресов с координатами
- `charts_data` - данные для построения графиков (опционально)
- `comparative_analysis` - результаты предыдущих анализов (опционально)

## Форматы данных

### Структура области (area)
```javascript
{
    id: number,
    name: string,
    polygon: [[lat, lng], ...],
    created_at: string,
    updated_at: string
}
```

### Объект недвижимости (real_estate_object)
```javascript
{
    id: number,
    address: string,
    area: number,         // площадь в м²
    rooms: number,        // количество комнат
    house_type: string,   // тип дома
    house_series: string, // серия дома
    status: string,       // статус ('active'|'archived')
    updated_at: string
}
```

### Объявление (listing)
```javascript
{
    id: number,
    real_estate_object_id: number,
    source: string,       // 'avito'|'cian'
    price: number,        // цена в рублях
    status: string,       // статус объявления
    url: string,         // ссылка на источник
    date: string,        // дата публикации
    updated_at: string
}
```

### Адрес (address)
```javascript
{
    id: number,
    address: string,
    coordinates: [lat, lng],
    house_year: number,      // год постройки
    house_series: string,    // серия дома
    floors: number,          // этажность
    house_class: string,     // класс дома
    house_problems: string,  // проблемы дома
    commercial_spaces: boolean, // наличие коммерции
    comment: string          // комментарий
}
```

## Использование

### Создание экземпляра
```javascript
const htmlExportManager = new HTMLExportManager();
```

### Экспорт отчёта
```javascript
const exportData = {
    area: areaData,
    real_estate_objects: objectsArray,
    listings: listingsArray,
    addresses: addressesArray,
    charts_data: chartsData // опционально
};

const filename = `neocenka_report_${area.name}_${date}.html`;
await htmlExportManager.downloadHTMLReport(exportData, filename);
```

## Отладка и логирование

### Debug режим
```javascript
// Включение отладочных сообщений в консоли
const debugEnabled = true; // из настроек приложения

if (debugEnabled) {
    console.log('🚀 Инициализация HTML-отчёта');
    console.log('📊 Таблица дублей инициализирована:', count);
}
```

### Обработка ошибок
- Все методы используют try-catch блоки
- Подробное логирование ошибок в консоль
- Graceful degradation при отсутствии данных
- Fallback значения для некорректных данных

## Совместимость

### Браузеры
- Chrome/Chromium 90+
- Firefox 88+
- Safari 14+
- Edge 90+

### Внешние зависимости
- **jQuery 3.7.1** - DOM манипуляции и AJAX
- **Tailwind CSS** - стилизация интерфейса
- **Leaflet 1.9.4** - интерактивные карты
- **ApexCharts 3.x** - графики и диаграммы
- **DataTables 1.13.x** - интерактивные таблицы

## Ограничения

### Размер файла
- Большие области (>1000 объектов) могут создавать файлы >10MB
- JSON данные встраиваются прямо в HTML
- Рекомендуется сегментирование больших областей

### Производительность
- Инициализация всех компонентов может занимать 2-3 секунды
- Карта с >500 маркерами может работать медленно
- DataTables оптимизированы для <1000 строк

### Автономность
- Требует подключения к интернету только при первой загрузке (CDN)
- После загрузки работает полностью оффлайн
- Нельзя обновить данные без пересоздания файла

## Планы развития

### Версия 1.1
- [ ] Добавление экспорта в PDF
- [ ] Поддержка кастомных тем оформления
- [ ] Расширенная фильтрация в таблице объектов
- [ ] Экспорт данных в Excel/CSV

### Версия 1.2  
- [ ] Сравнение нескольких областей в одном отчёте
- [ ] Интеграция с внешними картографическими сервисами
- [ ] Расширенная аналитика и прогнозирование
- [ ] Система комментариев и аннотаций

## Заключение

HTMLExportManager обеспечивает создание полнофункциональных автономных HTML-отчётов для анализа рынка недвижимости. Отчёты содержат все необходимые инструменты для профессиональной работы риелторов и инвесторов, включая интерактивные карты, графики, таблицы и систему сравнительного анализа.