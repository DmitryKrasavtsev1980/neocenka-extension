# MapManager.js - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

> **–§–∞–π–ª:** `pages/managers/MapManager.js`  
> **–†–∞–∑–º–µ—Ä:** ~2250 —Å—Ç—Ä–æ–∫  
> **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ Neocenka  

## –û–±–∑–æ—Ä

MapManager —è–≤–ª—è–µ—Ç—Å—è –æ–¥–Ω–∏–º –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã, –æ—Ç–≤–µ—á–∞—é—â–∏–º –∑–∞ –≤—Å–µ –∞—Å–ø–µ–∫—Ç—ã —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Ä—Ç–∞–º–∏: –æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Leaflet –¥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ—è–º–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ –∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏.

## –û—Å–Ω–æ–≤–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å

- üó∫Ô∏è **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç** - —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Leaflet –∫–∞—Ä—Ç
- üìç **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞–º–∏** - —Å–æ–∑–¥–∞–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –∞–¥—Ä–µ—Å–æ–≤ –∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
- üé® **–°–∏—Å—Ç–µ–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤** - –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º (–≥–æ–¥, —Å–µ—Ä–∏—è –¥–æ–º–æ–≤, –º–∞—Ç–µ—Ä–∏–∞–ª —Å—Ç–µ–Ω)
- üîó **–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è** - –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- üéØ **–ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã** - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–º –æ–±–ª–∞—Å—Ç—è–º
- üñºÔ∏è **–°–ª–æ–∏ –∫–∞—Ä—Ç—ã** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–∞

### –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
```javascript
constructor(dataState, eventBus, progressManager) {
    // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (—á–∞—Å—Ç–∏—á–Ω–∞—è DI)
    this.dataState = dataState;
    this.eventBus = eventBus;
    this.progressManager = progressManager;
    
    // –û–±—ä–µ–∫—Ç—ã Leaflet –∫–∞—Ä—Ç—ã
    this.map = null;                    // –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä–µ–∫—Ç –∫–∞—Ä—Ç—ã
    this.drawnItems = null;            // –°–ª–æ–π –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
    this.drawControl = null;           // –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    this.areaPolygonLayer = null;      // –°–ª–æ–π –ø–æ–ª–∏–≥–æ–Ω–∞ –æ–±–ª–∞—Å—Ç–∏
    
    // –°–∏—Å—Ç–µ–º–∞ —Å–ª–æ–µ–≤
    this.mapLayers = {
        addresses: null,               // –°–ª–æ–π –∞–¥—Ä–µ—Å–æ–≤
        objects: null,                // –°–ª–æ–π –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
        listings: null                // –°–ª–æ–π –æ–±—ä—è–≤–ª–µ–Ω–∏–π
    };
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    this.spatialIndex = window.geoUtils || new GeoUtils();
    this.indexedAddresses = new Map();
    this.markerCache = new Map();
}
```

### –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π
```javascript
bindEvents() {
    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    this.eventBus.on(CONSTANTS.EVENTS.AREA_LOADED, this.onAreaLoaded);
    this.eventBus.on(CONSTANTS.EVENTS.ADDRESSES_LOADED, this.loadAddressesOnMap);
    this.eventBus.on(CONSTANTS.EVENTS.LISTINGS_IMPORTED, this.loadListingsOnMap);
    this.eventBus.on(CONSTANTS.EVENTS.MAP_FILTER_CHANGED, this.toggleMapFilter);
}
```

## –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
```javascript
async initializeMap(mapElementId = 'map') {
    // –°–æ–∑–¥–∞–Ω–∏–µ Leaflet –∫–∞—Ä—Ç—ã
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–π–ª–æ–≤—ã—Ö —Å–ª–æ–µ–≤ (OpenStreetMap)
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–∞—Ä—Ç—ã
}
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞–º–∏
```javascript
async loadAddressesOnMap() {
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –∞–¥—Ä–µ—Å–æ–≤
    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    // –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
}

createAddressMarker(address) {
    // –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ –∞–¥—Ä–µ—Å–∞
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ popup –æ–∫–æ–Ω
    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º
}
```

### –°–∏—Å—Ç–µ–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
```javascript
toggleMapFilter(filterType) {
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
}

// –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:
// - 'year' - –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
// - 'series' - —Å–µ—Ä–∏—è –¥–æ–º–∞  
// - 'material' - –º–∞—Ç–µ—Ä–∏–∞–ª —Å—Ç–µ–Ω
// - 'floors' - —ç—Ç–∞–∂–Ω–æ—Å—Ç—å
```

### –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
```javascript
filterAddressesByPolygon(addresses, polygon) {
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∞–¥—Ä–µ—Å–æ–≤ –ø–æ –≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏
    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
}
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### Leaflet.js
- **–í–µ—Ä—Å–∏—è:** –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è
- **–ü–ª–∞–≥–∏–Ω—ã:** Leaflet.draw –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ø–æ–ª–∏–≥–æ–Ω–æ–≤
- **–¢–∞–π–ª—ã:** OpenStreetMap
- **–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è:** –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –º–∞—Ä–∫–µ—Ä–æ–≤

### DataState –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
```javascript
// –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
const addresses = this.dataState.getState('addresses');
const currentArea = this.dataState.getState('currentArea');
this.dataState.setState('activeMapFilter', filterType);
```

### EventBus –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
```javascript
// –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
this.eventBus.emit(CONSTANTS.EVENTS.MAP_INITIALIZED, {mapId: 'map'});
this.eventBus.emit(CONSTANTS.EVENTS.MARKERS_UPDATED, markerData);

// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
this.eventBus.on(CONSTANTS.EVENTS.AREA_UPDATED, this.refreshMapData);
```

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
```javascript
// –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤
this.markerCache = new Map();

getOrCreateMarker(addressId) {
    if (!this.markerCache.has(addressId)) {
        this.markerCache.set(addressId, this.createAddressMarker(address));
    }
    return this.markerCache.get(addressId);
}
```

### –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
```javascript
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RBush –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
this.spatialIndex = new GeoUtils();
this.spatialIndex.addAddresses(addresses);
const filtered = this.spatialIndex.getAddressesInPolygon(polygon);
```

### –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
```javascript
// –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Ä–æ–≤–Ω—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
setupViewportUpdates() {
    this.map.on('zoomend moveend', debounce(() => {
        if (this.map.getZoom() >= 14) {
            this.updateVisibleMarkers();
        }
    }, 500));
}
```

## –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### üî¥ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–ù–∞—Ä—É—à–µ–Ω–∏–µ SRP** - –∫–ª–∞—Å—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–π:
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ–π
   - –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π
   - –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è

2. **–ü–ª–æ—Ç–Ω–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å** - –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ DOM —ç–ª–µ–º–µ–Ω—Ç—ã:
   ```javascript
   document.getElementById('refreshMapBtn')?.addEventListener(...) // ‚ùå
   ```

3. **–°–º–µ—à–∏–≤–∞–Ω–∏–µ —Å–ª–æ–µ–≤** - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–º–µ—à–∞–Ω–∞ —Å UI –ª–æ–≥–∏–∫–æ–π

### üü° –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

1. **–ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ DOM –æ–ø–µ—Ä–∞—Ü–∏–∏**:
   ```javascript
   // –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ DOM –≤ —Ü–∏–∫–ª–∞—Ö
   for (let address of addresses) {
       const marker = this.createAddressMarker(address); // –°–æ–∑–¥–∞–µ—Ç DOM —ç–ª–µ–º–µ–Ω—Ç—ã
   }
   ```

2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏** –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –º–∞—Ä–∫–µ—Ä–æ–≤ (>1000)

3. **–ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è** - –ø–µ—Ä–µ—Å—á–µ—Ç –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏

### üü° –ü—Ä–æ–±–ª–µ–º—ã —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è

1. **–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞** - 2250+ —Å—Ç—Ä–æ–∫ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏** - –Ω–µ—Ç JSDoc –∏–ª–∏ TypeScript
3. **–°–º–µ—à–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏** - —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –º–æ–¥—É–ª–∏**:
   ```javascript
   // –†–∞–∑–±–∏—Ç—å –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã
   class MapRenderer {           // –¢–æ–ª—å–∫–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ä—Ç—ã
   class MarkerManager {         // –¢–æ–ª—å–∫–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞–º–∏  
   class LayerManager {          // –¢–æ–ª—å–∫–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ—è–º–∏
   class SpatialQueryEngine {    // –¢–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
   ```

2. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏**:
   ```typescript
   interface MarkerConfig {
       id: string;
       position: LatLng;
       icon: IconConfig;
       popup?: PopupConfig;
   }
   ```

3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**:
   ```javascript
   class VirtualMarkerManager {
       // –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤ –º–∞—Ä–∫–µ—Ä–æ–≤
       renderVisibleMarkers(viewport: Bounds) { /* */ }
   }
   ```

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **Event-driven –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**:
   ```javascript
   class MapEventHandler {
       // –û—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π –∫–∞—Ä—Ç—ã
       handleMarkerClick(event: MarkerClickEvent) { /* */ }
       handleZoomChange(event: ZoomChangeEvent) { /* */ }
   }
   ```

2. **Dependency Injection**:
   ```javascript
   @Injectable()
   class MapManager {
       constructor(
           @Inject('MarkerRenderer') private markerRenderer: IMarkerRenderer,
           @Inject('SpatialIndex') private spatialIndex: ISpatialIndex
       ) {}
   }
   ```

3. **Reactive Programming**:
   ```javascript
   // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RxJS –¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
   this.dataState.addresses$
       .pipe(
           debounceTime(300),
           switchMap(addresses => this.updateMarkers(addresses))
       )
       .subscribe();
   ```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- ‚ùå –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç–æ–≤ –Ω–µ—Ç
- ‚ùå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –Ω–µ—Ç  
- ‚ö†Ô∏è –¢–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ UI

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ —Ç–µ—Å—Ç—ã
```javascript
describe('MapManager', () => {
    describe('marker creation', () => {
        it('should create marker with correct properties', () => {
            const marker = mapManager.createAddressMarker(mockAddress);
            expect(marker.getLatLng()).toEqual(mockAddress.coordinates);
        });
    });
    
    describe('spatial filtering', () => {
        it('should filter addresses by polygon', () => {
            const filtered = mapManager.filterAddressesByPolygon(addresses, polygon);
            expect(filtered).toHaveLength(expectedCount);
        });
    });
});
```

## API Reference

### –ü—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã

#### `initializeMap(mapElementId: string): Promise<void>`
–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–∞—Ä—Ç—É –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º DOM —ç–ª–µ–º–µ–Ω—Ç–µ.

#### `loadAddressesOnMap(): Promise<void>`  
–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∞–¥—Ä–µ—Å–∞ –Ω–∞ –∫–∞—Ä—Ç–µ —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —Ñ–∏–ª—å—Ç—Ä–æ–≤.

#### `toggleMapFilter(filterType: string): void`
–ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤.

#### `addMarker(config: MarkerConfig): Marker`
–î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä –Ω–∞ –∫–∞—Ä—Ç—É.

#### `removeMarker(markerId: string): void`
–£–¥–∞–ª—è–µ—Ç –º–∞—Ä–∫–µ—Ä —Å –∫–∞—Ä—Ç—ã.

### –°–æ–±—ã—Ç–∏—è

#### `MAP_INITIALIZED`
–ò—Å–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã.
```javascript
{
    mapId: string,
    center: LatLng,
    zoom: number
}
```

#### `MARKERS_UPDATED` 
–ò—Å–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ.
```javascript
{
    markersCount: number,
    visibleCount: number,
    filterType: string
}
```

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- [`pages/core/DataState.js`](../core/doc_DataState.md) - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
- [`pages/core/EventBus.js`](../core/doc_EventBus.md) - —Å–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π  
- [`utils/geometry-utils.js`](../../utils/doc_geometry-utils.md) - –≥–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
- [`pages/shared/constants.js`](../shared/doc_constants.md) - –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

---

*–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞ MapManager.js v0.3.4*