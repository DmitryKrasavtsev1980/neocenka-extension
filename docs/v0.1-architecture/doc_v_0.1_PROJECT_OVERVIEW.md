# Документация проекта Neocenka Extension v0.1

## Обзор проекта

**Neocenka Extension** — это Chrome расширение для анализа рынка недвижимости, предназначенное для риэлторов и инвесторов для анализа локальных сегментов недвижимости. Расширение парсит объявления с Avito.ru и Cian.ru, создает объекты недвижимости и генерирует аналитические отчеты.

### Ключевые изменения в версии 0.1

После масштабного архитектурного рефакторинга проект полностью переработан с внедрением современных архитектурных паттернов:

- ✅ **Устранение God Object антипаттерна** - SegmentsManager разбит на 12 специализированных компонентов
- ✅ **Принципы SOLID** - каждый компонент имеет единственную ответственность
- ✅ **Dependency Injection** - слабая связанность через DI контейнер
- ✅ **Event-driven архитектура** - компоненты взаимодействуют через события
- ✅ **Централизованные сервисы** - валидация, конфигурация, обработка ошибок
- ✅ **Система мониторинга** - глобальное отслеживание здоровья и производительности

## Технологический стек

### Основные технологии
- **Chrome Extension Manifest V3** - Современная архитектура расширений
- **IndexedDB v17** - Локальное хранение с комплексной реляционной структурой
- **Tailwind CSS 4.1** - UI стилизация
- **Leaflet + OpenStreetMap** - Интерактивные карты с рисованием полигонов
- **ApexCharts** - Графики и аналитика
- **DataTables** - Расширенный функционал таблиц
- **SlimSelect** - Улучшенные селекты

### Новая архитектурная база
- **Dependency Injection Container** - Управление зависимостями
- **Event Bus System** - Межкомпонентная коммуникация
- **Reactive Configuration** - Динамическое обновление настроек
- **Global Error Reporting** - Централизованная обработка ошибок
- **Service Layer Architecture** - Разделение бизнес-логики

## Структура проекта после рефакторинга

```
neocenka-extension/
├── background/              # Service Worker
├── content-scripts/         # Парсеры сайтов
├── popup/                  # Интерфейс popup
├── pages/                  # Основные страницы приложения
│   ├── area.html           # Страница управления областями
│   ├── area.js             # Контроллер страницы областей
│   ├── main.html           # Главная страница
│   ├── main.js             # Контроллер главной страницы
│   ├── core/               # Ядро архитектуры
│   │   ├── DataState.js    # Управление состоянием
│   │   ├── EventBus.js     # Система событий
│   │   └── ProgressManager.js # Отслеживание прогресса
│   ├── shared/             # Общие утилиты
│   │   ├── constants.js    # Константы приложения
│   │   ├── helpers.js      # Вспомогательные функции
│   │   └── validators.js   # Валидаторы данных
│   └── managers/           # Функциональные менеджеры (legacy)
│       ├── UIManager.js    # Управление UI
│       ├── MapManager.js   # Управление картой (legacy)
│       ├── SegmentsManager.js # Управление сегментами (legacy)
│       └── ReportsManager.js # Генерация отчетов
├── services/               # Новая сервисная архитектура
│   ├── core/               # Базовые сервисы
│   │   ├── ValidationService.js    # Централизованная валидация
│   │   ├── ConfigService.js        # Управление конфигурацией
│   │   ├── ErrorHandlingService.js # Обработка ошибок
│   │   ├── DIContainer.js          # Dependency Injection
│   │   └── GlobalErrorReporter.js  # Глобальный мониторинг
│   └── data/               # Сервисы данных
│       ├── SegmentService.js       # Бизнес-логика сегментов
│       └── ReferenceDataService.js # Справочные данные
├── components/             # UI компоненты
│   ├── ui/                 # Пользовательские компоненты
│   │   ├── SegmentModal.js    # Модальные окна сегментов
│   │   ├── SegmentTable.js    # Таблицы сегментов
│   │   └── SegmentChart.js    # Графики сегментов
│   └── map/                # Компоненты карты
│       ├── MapRenderer.js     # Отрисовка карты
│       └── MarkerManager.js   # Управление маркерами
├── controllers/            # Контроллеры (новая архитектура)
│   ├── ApplicationController.js # Главный контроллер
│   ├── SegmentController.js     # Контроллер сегментов
│   └── MapController.js         # Контроллер карты
├── data/                   # Модели данных и база
├── utils/                  # Утилиты и вспомогательные функции
└── docs/                   # Документация проекта
    ├── ARCHITECTURE_INTEGRATION.md # План интеграции
    └── doc_v_0.1_*.md              # Документация v0.1
```

## Ключевые архитектурные компоненты

### 1. Dependency Injection System
- **DIContainer.js** - Управление зависимостями
- **Singleton поддержка** - Контролируемые экземпляры сервисов
- **Автоматическая инициализация** - Топологическая сортировка зависимостей
- **Циклическая защита** - Предотвращение циклических ссылок

### 2. Service Layer
#### Базовые сервисы:
- **ValidationService** - Централизованная валидация всех типов данных
- **ConfigService** - Реактивное управление конфигурацией
- **ErrorHandlingService** - Обработка ошибок с автоповторами
- **GlobalErrorReporter** - Система мониторинга и health checks

#### Сервисы данных:
- **SegmentService** - Бизнес-логика работы с сегментами
- **ReferenceDataService** - Управление справочными данными

### 3. UI Component Architecture
- **SegmentModal** - Модальные окна для сегментов
- **SegmentTable** - Таблицы с DataTables интеграцией
- **SegmentChart** - Графики с ApexCharts
- **MapRenderer** - Leaflet карты и слои
- **MarkerManager** - Маркеры и кластеризация

### 4. Controller Layer
- **ApplicationController** - Главный координатор приложения
- **SegmentController** - Координатор сегментной логики
- **MapController** - Координатор карты и геоданных

## Основные модели данных

### Первичные сущности:
1. **MapArea** (`map_areas`) - Географические области с полигонами
2. **Address** (`addresses`) - Адреса недвижимости с координатами
3. **Segment** (`segments`) - Сегменты с фильтрами внутри областей
4. **Listing** (`listings`) - Парсенные объявления с внешних сайтов
5. **RealEstateObject** (`real_estate_objects`) - Агрегированные объекты из объявлений

### Схема базы данных:
- **Версия:** 17 (IndexedDB с миграциями)
- **Связи:** Area → Segments → Objects → Listings → Addresses
- **Пространственный индекс:** RBush для географических запросов

## Поток данных приложения

1. **Создание областей:** Пользователи рисуют полигоны на карте
2. **Управление адресами:** Геокодирование и привязка к адресам
3. **Парсинг объявлений:** Content scripts извлекают данные с Avito/Cian
4. **Обработка дубликатов:** Умные алгоритмы объединения объявлений
5. **Создание сегментов:** Фильтрация по характеристикам недвижимости
6. **Аналитика:** ApexCharts генерируют отчеты по ценам и ликвидности

## Внешние интеграции

### Поддерживаемые источники:
- **Avito.ru** - Основной источник с отслеживанием истории цен
- **Cian.ru** - Вторичный источник объявлений
- **Inpars.ru API** - Дополнительные данные недвижимости (подписка)

### API сервисы:
- Клиент API с ограничением скорости для Inpars
- Система управления подписками
- Автоматические уведомления об обновлениях через GitHub API

## Производительность и оптимизация

### Новые оптимизации:
- **Spatial Indexing** - RBush для быстрых географических запросов
- **Service Caching** - Многоуровневое кэширование сервисов
- **Event Batching** - Группировка событий для производительности
- **Memory Management** - Контроль утечек памяти
- **Progressive Loading** - Ленивая загрузка компонентов

### Мониторинг:
- **Health Checks** - Автоматический мониторинг состояния системы
- **Performance Metrics** - Отслеживание производительности
- **Error Reporting** - Глобальное логирование ошибок
- **Memory Usage** - Контроль использования памяти

## Система подписок и лицензирование

Расширение включает систему подписок с проверкой `https://neocenka.ru/api/neocenka-extension/{api-key}` для премиум функций. В настоящее время работает в тестовом режиме с mock-ответами.

## Процесс сборки и релиза

### Команды разработки:
```bash
# Установка зависимостей
npm install

# Сборка CSS (разработка с watch)
npm run build-css

# Сборка CSS (продакшен, минифицированный)
npm run build

# Сборка и упаковка расширения
npm run package

# Полная сборка с созданием ZIP
npm run build-extension
```

### Автоматизация:
- GitHub Actions автоматизируют workflow релизов
- Создается ZIP архив и updates.xml для автообновлений
- Версионирование через `package.json`

## Тестирование

### Типы тестов:
- **HTML-based тесты** в директории `/tests/` (ручное тестирование)
- **Интеграционные тесты** для функциональности парсеров
- **Миграционные тесты** для базы данных
- **Architecture compliance тесты** для новой структуры

## Безопасность

### Content Security Policy:
- Все inline скрипты конвертированы в external файлы
- Event listeners используют `addEventListener` вместо inline обработчиков
- Внешние библиотеки загружаются локально для соответствия CSP

### Данные:
- Никогда не выводятся секреты и ключи в логи
- Секреты не коммитятся в репозиторий
- Персональные данные обрабатываются согласно политике приватности

## Документация версии 0.1

Данная версия включает полную документацию всех компонентов:
- `doc_v_0.1_PROJECT_OVERVIEW.md` - Обзор проекта (этот файл)
- `doc_v_0.1_ARCHITECTURE.md` - Детальная архитектура
- `doc_v_0.1_SERVICES.md` - Описание всех сервисов
- `doc_v_0.1_COMPONENTS.md` - UI компоненты
- `doc_v_0.1_CONTROLLERS.md` - Контроллеры
- `doc_v_0.1_DATABASE.md` - Схема базы данных
- `doc_v_0.1_API.md` - API референс
- И дополнительные специализированные документы

## Миграция с предыдущей версии

Для интеграции новой архитектуры см. `ARCHITECTURE_INTEGRATION.md` - детальный план поэтапного перехода с обратной совместимостью.

---

**Версия документации:** 0.1  
**Дата создания:** Август 2025  
**Статус:** Архитектурный рефакторинг завершен, готов к интеграции