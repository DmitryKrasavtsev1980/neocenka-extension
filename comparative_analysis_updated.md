# Сравнительный анализ недвижимости

## Описание задачи

**Сравнительный анализ** - это инструмент для определения оптимальной стартовой цены объекта недвижимости путем пошагового сравнения с конкурентами на рынке.

### Цель
Максимально сузить коридор продаж для определения стартовой цены выхода в продажу путем визуального сравнительного анализа абстрактного объекта оценки с конкурентами из базы.

### Принцип работы
1. **Абстрактный объект оценки** - мысленный объект, который планируется выставить на продажу (не требует ввода в базу данных)
2. **Пошаговое сравнение** - оценка каждого конкурента из базы относительно абстрактного объекта оценки
3. **Статусы оценки**:
   - **"Лучше"** → конкурент лучше нашего абстрактного объекта
   - **"Хуже"** → конкурент хуже нашего абстрактного объекта  
   - **"Равно"** → конкурент равен нашему абстрактному объекту
   - **"Фейк"** → поддельное/недостоверное объявление
   - **"Не конкурент"** → не является конкурентом (другая планировка, сильно другая площадь)
   - **"Не продан"** → архивный объект, который ушел с рынка, но не был продан
4. **Динамическое сужение коридора**:
   - **"Лучше"** → верхняя граница коридора опускается до цены этого конкурента
   - **"Хуже"** → нижняя граница коридора поднимается до цены этого конкурента
   - **"Равно"** → объект остается в коридоре без изменения границ
   - **"Фейк/Не конкурент/Не продан"** → объект исключается из анализа (не влияет на коридор)
5. **Разделение по статусам** - отдельные коридоры для активных и архивных объектов
6. **Определение оптимальной цены** - пересечение коридоров активных и архивных объектов

### Сохранение результатов
- Сохранение оценок каждого анализа с возможностью последующего просмотра
- Форма управления сохраненными анализами (просмотр, корректировка, удаление)
- Привязка анализа к сегменту и временному периоду

## Основные уточнения

1. **Абстрактный объект** - мы оцениваем объекты из базы относительно мысленного объекта, который не нужно вводить в систему
2. **Только одно сравнение** - сравниваем один абстрактный объект со всеми конкурентами (активными и архивными)
3. **Обязательное сохранение** - результаты анализа должны сохраняться с возможностью управления
4. **Статус "Не продан"** - дополнительный статус для архивных объектов, которые ушли с рынка, но не были проданы
5. **Экспорт не нужен** - пока не делаем, будет в комплексном экспорте позже

## Интерфейс

### Левая панель - Интерфейс сравнения
```
┌─────────────────────────────────────┐
│ [Новый анализ] [Сохранить] [Загрузить] │
├─────────────────────────────────────┤
│ Фильтр статусов: [Все][Активные][Архивные] │
├─────────────────────────────────────┤
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐     │
│ │ Id  │ │ Id  │ │ Id  │ │ Id  │     │
│ │2024 │ │2030 │ │2031 │ │...  │     │
│ └─────┘ └─────┘ └─────┘ └─────┘     │
├─────────────────────────────────────┤
│ Объявления выбранного объекта:      │
│ ┌─────────────────────────────────┐ │
│ │ Id 186044 (последнее обновление)│ │
│ │ Id 186046                       │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│ Фото и описание объявления          │
│ ┌─────────────────────────────────┐ │
│ │ [Фото] [Фото] [Фото] [Фото]     │ │
│ │                                 │ │
│ │ Описание объявления...          │ │
│ └─────────────────────────────────┘ │
├─────────────────────────────────────┤
│ Кнопки оценки:                      │
│ [Фейк][Не конкурент][Не продан][Хуже][Равно][Лучше] │
└─────────────────────────────────────┘
```

### Правая панель - График коридора с оценками
- **Базовый график** - аналог "Коридор рынка недвижимости" (режим "Коридор продаж")
- **Цветовая схема**:
  - **Зеленый** - архивные объекты (базовый)
  - **Синий** - активные объекты (базовый)
  - **Темнее** - объекты оцененные как "Хуже"
  - **Светлее** - объекты оцененные как "Лучше"
  - **Красный** - "Фейк", "Не конкурент" или "Не продан"
- **Горизонтальные линии** - границы суженного коридора для активных и архивных объектов
- **Пересечение коридоров** - оптимальный диапазон цен

## План реализации

### Этап 1: Создание базовой структуры
1. Добавление вкладки "Сравнительный анализ" в area.html
2. HTML интерфейс с левой панелью сравнения и правой панелью графика
3. CSS стили для элементов интерфейса

### Этап 2: Менеджер сравнительного анализа
1. Создание ComparativeAnalysisManager.js
2. Система оценок и управления состоянием
3. Алгоритм расчета коридоров цен
4. Интеграция с существующими менеджерами

### Этап 3: Визуализация
1. График на основе ApexCharts (аналог графика коридора рынка)
2. Цветовая схема для разных статусов оценки
3. Горизонтальные линии коридоров
4. Tooltip с информацией об объектах

### Этап 4: Сохранение и управление
1. Сохранение результатов анализа в IndexedDB
2. Форма загрузки/управления сохраненными анализами
3. Возможность корректировки и удаления

### Этап 5: Интеграция
1. Подключение к area.js
2. Обновление database.js для работы с анализами
3. Тестирование функциональности

## Технические детали

### Структура данных оценки:
```javascript
{
  analysisId: "uuid",
  name: "Название анализа",
  evaluations: {
    "objectId1": "better",
    "objectId2": "worse",
    "objectId3": "equal",
    "objectId4": "fake"
  },
  corridors: {
    active: { min: 5000000, max: 6500000 },
    archive: { min: 4800000, max: 6200000 },
    optimal: { min: 5000000, max: 6200000 }
  },
  filters: {
    segmentId: "123",
    subsegmentId: "456", 
    dateFrom: "2024-01-01",
    dateTo: "2024-12-31"
  },
  timestamp: "2024-01-15T10:30:00Z"
}
```

### Алгоритм сужения коридора:
```javascript
// Для каждого статуса (active/archive) отдельно:
for (let [objectId, evaluation] of evaluations) {
  if (evaluation === 'better') {
    // Опускаем верхнюю границу
    maxPrice = Math.min(maxPrice, object.current_price);
  }
  if (evaluation === 'worse') {
    // Поднимаем нижнюю границу  
    minPrice = Math.max(minPrice, object.current_price);
  }
  // equal - не влияет на границы
  // fake/not-competitor/not-sold - исключаются полностью
}
```

Готов приступить к реализации! С чего начинаем?